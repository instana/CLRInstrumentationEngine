# Copyright (c) Microsoft Corporation. All rights reserved.
# Licensed under the MIT License.

# Job Template: Test Linux Binaries

jobs:
- job: Test_Linux_Binaries
  displayName: Linux Tests

  pool:
    ${{ if eq(variables['System.TeamProject'], 'devdiv') }}:
      name: AzurePipelines-EO
      demands: ImageOverride -equals AzurePipelinesUbuntu20.04compliant
    ${{ else }}:
      vmImage: ubuntu-latest

  workspace:
    clean: outputs

  variables:
    configuration: Debug

  steps:
#  - download: current
#    patterns: |
#      binaries-windows-$(Configuration)/AnyCPU/**
#      binaries-linux-ubuntu-$(Configuration)/ClrInstrumentationEngine/**

  - template: ../../steps/azuredevops/downloadbuildartifacts.yaml
    parameters:
      ArtifactName: binaries-windows-$(Configuration)

  - template: ../../steps/azuredevops/downloadbuildartifacts.yaml
    parameters:
      ArtifactName: binaries-linux-ubuntu-$(Configuration)

  # Simulate DeploymentItem by copying the Linux binaries
  - task: CopyFiles@2
    displayName: Setup Linux binaries for tests 
    inputs:
      sourceFolder: $(Build.StagingDirectory)/binaries-linux-ubuntu-$(Configuration)/ClrInstrumentationEngine/
      targetFolder: $(Build.StagingDirectory)/binaries-windows-$(Configuration)/AnyCPU/net70/

  - task: UseDotNet@2
    displayName: 'Use .NET 7 sdk'
    inputs:
      version: 7.0.x
      includePreviewVersions: true
      installationPath: $(Agent.TempDirectory)/dotnet

  # Environment variable used by tests
  - bash: |
      echo "##vso[task.setvariable variable=DOTNET_EXE]$(Agent.TempDirectory)/dotnet/dotnet"

  - task: DotNetCoreCLI@2
    displayName: 'Run Tests: InstrEngineTests.dll'
    inputs:
      command: test
      workingDirectory: $(Agent.TempDirectory)/dotnet 
      arguments: $(Build.StagingDirectory)/binaries-windows-$(Configuration)/AnyCPU/net70/InstrEngineTests.dll
      testRunTitle: Linux Nagler Tests
      publishTestResults: true
    condition: succeededOrFailed()

  #- script: $(Agent.TempDirectory)/dotnet $(Pipeline.Workspace)/binaries-windows-Debug/AnyCPU/net70/InstrEngineTests.dll
